{% extends 'base.html' %}

{% block title %}Накладная {{ invoice.number }}{% endblock %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'warehouse:invoice_list' %}">Накладные</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ invoice.number }}</li>
        </ol>
    </nav>

    <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-file-text"></i> Накладная №{{ invoice.number }}</h4>
            {% if invoice.pdf_file %}
                <a href="{% url 'warehouse:invoice_download_pdf' invoice.pk %}" class="btn btn-light">
                    <i class="bi bi-file-pdf"></i> Скачать PDF
                </a>
            {% endif %}
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <th style="width: 30%">Номер:</th>
                            <td><strong>{{ invoice.number }}</strong></td>
                        </tr>
                        <tr>
                            <th>Дата создания:</th>
                            <td>{{ invoice.created_at|date:"d.m.Y H:i" }}</td>
                        </tr>
                        <tr>
                            <th>Создал:</th>
                            <td>{{ invoice.created_by.get_full_name|default:invoice.created_by.username }}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Статус:</strong> Проведена
                    </div>
                </div>
            </div>

            <h5 class="mb-3">Товары в накладной</h5>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>№</th>
                            <th>Артикул</th>
                            <th>Наименование</th>
                            <th class="text-center">Количество</th>
                            <th class="text-end">Цена</th>
                            <th class="text-end">Сумма</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in invoice.items.all %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td><strong>{{ item.product.sku }}</strong></td>
                                <td>
                                    <a href="{% url 'warehouse:product_detail' item.product.pk %}">
                                        {{ item.product.name }}
                                    </a>
                                </td>
                                <td class="text-center">{{ item.quantity }}</td>
                                <td class="text-end">{{ item.price|floatformat:2 }} ₽</td>
                                <td class="text-end fw-bold">{{ item.get_total|floatformat:2 }} ₽</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="table-info">
                            <td colspan="5" class="text-end"><strong>ИТОГО:</strong></td>
                            <td class="text-end fw-bold">
                                {% with total=0 %}
                                    {% for item in invoice.items.all %}
                                        {% with total=total|add:item.get_total %}
                                        {% endwith %}
                                    {% endfor %}
                                    {{ invoice.items.all|length|yesno:"Сумма,0" }}
                                {% endwith %}
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="row mt-5">
                <div class="col-md-6">
                    <p>Отпустил: ____________________</p>
                    <p class="text-muted small">(подпись, дата)</p>
                </div>
                <div class="col-md-6">
                    <p>Получил: ____________________</p>
                    <p class="text-muted small">(подпись, дата)</p>
                </div>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <a href="{% url 'warehouse:invoice_list' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> К списку накладных
                </a>
                <div>
                    <a href="javascript:window.print()" class="btn btn-info">
                        <i class="bi bi-printer"></i> Печать
                    </a>
                    {% if invoice.pdf_file %}
                        <a href="{% url 'warehouse:invoice_download_pdf' invoice.pk %}" class="btn btn-success">
                            <i class="bi bi-file-pdf"></i> Скачать PDF
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style media="print">
    @media print {
        .navbar, footer, .btn, .breadcrumb {
            display: none !important;
        }
        .card {
            border: none !important;
            box-shadow: none !important;
        }
        .card-header {
            background-color: #fff !important;
            color: #000 !important;
            border-bottom: 2px solid #000 !important;
        }
    }
</style>
{% endblock %}