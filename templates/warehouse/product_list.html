{% extends 'base.html' %}
{% load static %}

{% block title %}Список товаров{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="bi bi-boxes"></i> Товары на складе
        <small class="text-muted fs-5">({{ total_products }} шт.)</small>
    </h1>
    
    <div>
        <span class="badge bg-info fs-6">
            Общая стоимость: {{ total_value|floatformat:2 }} ₽
        </span>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                {{ form.query }}
            </div>

            <div class="col-md-2">
                {{ form.category }}
            </div>

            <div class="col-md-2">
                <div class="form-check mt-2">
                    {{ form.in_stock }}
                    <label class="form-check-label" for="{{ form.in_stock.id_for_label }}">
                        Только в наличии
                    </label>
                </div>
            </div>

            <div class="col-md-2">
                <div class="form-check mt-2">
                    {{ form.low_stock }}
                    <label class="form-check-label" for="{{ form.low_stock.id_for_label }}">
                        Остаток ниже минимума
                    </label>
                </div>
            </div>

            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> Найти
                </button>
            </div>
        </form>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-hover table-striped">
        <thead class="table-dark">
            <tr>
                <th>Артикул</th>
                <th>Наименование</th>
                <th>Категория</th>
                <th>Цена</th>
                <th>Количество</th>
                <th>Сумма</th>
                <th>Местоположение</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for product in page_obj %}
            <tr class="{% if product.is_low_stock %}table-warning{% endif %}">
                <td><strong>{{ product.sku }}</strong></td>
                <td>
                    <a href="{% url 'warehouse:product_detail' product.pk %}">
                        {{ product.name }}
                    </a>
                </td>
                <td>{{ product.category.name|default:"-" }}</td>
                <td class="text-end">{{ product.price|floatformat:2 }} ₽</td>
                <td class="text-center {% if product.quantity == 0 %}text-danger fw-bold{% endif %}">
                    {{ product.quantity }}
                    {% if product.is_low_stock %}
                        <i class="bi bi-exclamation-triangle-fill text-warning"
                           title="Остаток ниже минимума ({{ product.min_quantity }})"></i>
                    {% endif %}
                </td>
                <td class="text-end">{{ product.get_total_value|floatformat:2 }} ₽</td>
                <td>{{ product.location|default:"-" }}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <a href="{% url 'warehouse:product_detail' product.pk %}"
                           class="btn btn-info" title="Просмотр">
                            <i class="bi bi-eye"></i>
                        </a>

                        {% if user.is_staff %}
                            <a href="{% url 'warehouse:product_update' product.pk %}"
                               class="btn btn-warning" title="Редактировать">
                                <i class="bi bi-pencil"></i>
                            </a>
                        {% endif %}

                        <a href="{% url 'warehouse:stock_movement_create' %}?product={{ product.pk }}"
                           class="btn btn-success" title="Списание/приход">
                            <i class="bi bi-arrow-left-right"></i>
                        </a>

                        {% if user.is_staff %}
                            <a href="{% url 'warehouse:product_delete' product.pk %}"
                               class="btn btn-danger" title="Удалить"
                               onclick="return confirm('Вы уверены?')">
                                <i class="bi bi-trash"></i>
                            </a>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" class="text-center py-4">
                    <i class="bi bi-inbox fs-1 d-block text-muted"></i>
                    <p class="text-muted">Товары не найдены</p>

                    {% if user.is_staff %}
                        <a href="{% url 'warehouse:product_create' %}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Добавить первый товар
                        </a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if page_obj.has_other_pages %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% if request.GET.query %}&query={{ request.GET.query }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}">
                    &laquo; Первая
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.query %}&query={{ request.GET.query }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}">
                    Предыдущая
                </a>
            </li>
        {% endif %}

        <li class="page-item active">
            <span class="page-link">
                Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}
            </span>
        </li>

        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.query %}&query={{ request.GET.query }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}">
                    Следующая
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.query %}&query={{ request.GET.query }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}">
                    Последняя &raquo;
                </a>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
{% endblock %}